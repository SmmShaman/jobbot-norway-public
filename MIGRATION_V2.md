# JobBot Norway - Migration to v2 Architecture

## –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å?

### –°—Ç–∞—Ä–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (v1):
1. Worker –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–¥–∞—á—É —Å–æ —Å—Å—ã–ª–∫–æ–π –Ω–∞ –ø–æ–∏—Å–∫ FINN.no
2. Skyvern –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ–∏—Å–∫–∞ –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤–∞–∫–∞–Ω—Å–∏–π
3. –î–ª—è –∫–∞–∂–¥–æ–π –≤–∞–∫–∞–Ω—Å–∏–∏ Skyvern –ø–æ–≤—Ç–æ—Ä–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
4. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

**–ü—Ä–æ–±–ª–µ–º—ã:**
- Skyvern –º–µ–¥–ª–µ–Ω–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–ø–∏—Å–∫–æ–≤
- –ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è –∫–∞–∂–¥–æ–π –≤–∞–∫–∞–Ω—Å–∏–∏
- –°–ª–æ–∂–Ω–æ —Ä–∞—Å–ø–∞—Ä–∞–ª–ª–µ–ª–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É

### –ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (v2):
1. Worker –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–¥–∞—á—É —Å–æ —Å—Å—ã–ª–∫–æ–π –Ω–∞ –ø–æ–∏—Å–∫ FINN.no
2. **Worker —Å–∫–∞—á–∏–≤–∞–µ—Ç HTML –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Å—Å—ã–ª–∫–∏ —á–µ—Ä–µ–∑ regex** (–±—ã—Å—Ç—Ä–æ!)
3. **–°–æ–∑–¥–∞—é—Ç—Å—è –∑–∞–ø–∏—Å–∏ –≤ –ë–î –¥–ª—è –∫–∞–∂–¥–æ–π –≤–∞–∫–∞–Ω—Å–∏–∏ —Å—Ä–∞–∑—É** (—Å finnkode)
4. –ö–∞–∂–¥–∞—è –≤–∞–∫–∞–Ω—Å–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è Skyvern –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ
5. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å—è—Ö

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ë—ã—Å—Ç—Ä–∞—è —ç–∫—Å—Ç—Ä–∞–∫—Ü–∏—è —Å—Å—ã–ª–æ–∫ (regex –≤–º–µ—Å—Ç–æ Skyvern)
- ‚úÖ –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å –≤—Å–µ—Ö –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –≤–∞–∫–∞–Ω—Å–∏–π
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞–∂–¥–æ–π –≤–∞–∫–∞–Ω—Å–∏–∏
- ‚úÖ –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ –±—É–¥—É—â–µ–º
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

## –®–∞–≥–∏ –º–∏–≥—Ä–∞—Ü–∏–∏

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SQL —Ñ—É–Ω–∫—Ü–∏–π –≤ Supabase

–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL —Ñ–∞–π–ª –≤ Supabase SQL Editor:

```bash
database/finn_link_extractor_function.sql
```

–≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–∑–¥–∞–µ—Ç:
- `extract_finn_job_links(html_content)` - –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Å—Å—ã–ª–∫–∏ –∏–∑ HTML
- `create_jobs_from_finn_links(user_id, scan_task_id, html_content)` - —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å–∏ –≤–∞–∫–∞–Ω—Å–∏–π
- `get_pending_skyvern_jobs(user_id, limit)` - –ø–æ–ª—É—á–∞–µ—Ç –≤–∞–∫–∞–Ω—Å–∏–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ worker

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–æ–≤—ã–π worker:

```bash
# –°—Ç–∞—Ä—ã–π worker (v1)
python worker/worker.py

# –ù–æ–≤—ã–π worker (v2)
python worker/worker_v2.py
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

Worker v2 –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç—É –∂–µ —Ç–∞–±–ª–∏—Ü—É `jobs`, –ø–æ—ç—Ç–æ–º—É:
- ‚úÖ –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –≤ –±–∞–∑–µ
- ‚úÖ Frontend –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚úÖ –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É v1 –∏ v2

### 4. –ù–æ–≤—ã–µ –ø–æ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ jobs

Worker v2 –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–æ–ª–µ `skyvern_status` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:
- `PENDING` - –æ–∂–∏–¥–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ Skyvern
- `PROCESSING` - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è Skyvern
- `COMPLETED` - –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ
- `FAILED` - –æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–¥–∞—á–∏:

```
üìã SCAN TASK Created
    ‚Üì
üåê Fetch HTML from FINN.no
    ‚Üì
üîç Extract job links (regex: finnkode=\d+)
    ‚Üì
üíæ Create job entries in DB (skyvern_status=PENDING)
    ‚Üì
üìä Found N jobs
    ‚Üì
    ‚îú‚îÄ‚Üí Job 1: Call Skyvern ‚Üí Extract details ‚Üí Update DB
    ‚îú‚îÄ‚Üí Job 2: Call Skyvern ‚Üí Extract details ‚Üí Update DB
    ‚îú‚îÄ‚Üí Job 3: Call Skyvern ‚Üí Extract details ‚Üí Update DB
    ‚îî‚îÄ‚Üí ...
    ‚Üì
‚úÖ SCAN TASK Completed
```

### –ü—Ä–∏–º–µ—Ä SQL —Ñ—É–Ω–∫—Ü–∏–∏

```sql
-- –ò–∑–≤–ª–µ—á—å —Å—Å—ã–ª–∫–∏ –∏–∑ HTML
SELECT * FROM extract_finn_job_links('<html>...</html>');

-- –°–æ–∑–¥–∞—Ç—å –≤–∞–∫–∞–Ω—Å–∏–∏ –∏–∑ —Å—Å—ã–ª–æ–∫
SELECT * FROM create_jobs_from_finn_links(
    'user-uuid',
    'task-uuid',
    '<html>...</html>'
);

-- –ü–æ–ª—É—á–∏—Ç—å –≤–∞–∫–∞–Ω—Å–∏–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
SELECT * FROM get_pending_skyvern_jobs('user-uuid', 10);
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å SQL —Ñ—É–Ω–∫—Ü–∏–∏

```sql
-- Test link extraction
SELECT * FROM extract_finn_job_links('
    <a href="https://www.finn.no/job/fulltime/ad.html?finnkode=123456">Job 1</a>
    <a href="/job/fulltime/ad.html?finnkode=789012">Job 2</a>
');
```

### 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å worker v2

```bash
cd worker
python worker_v2.py
```

### 3. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞–¥–∞—á—É

–ß–µ—Ä–µ–∑ Frontend:
1. Settings ‚Üí FINN.no URL
2. Dashboard ‚Üí Start Scan
3. Monitor ‚Üí –°–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å

## –û—Ç–∫–∞—Ç –Ω–∞ v1

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏:

```bash
# –ü—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å—Ç–∞—Ä—ã–π worker
python worker/worker.py
```

–û–±–µ –≤–µ—Ä—Å–∏–∏ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã —Å –æ–¥–Ω–æ–π –∏ —Ç–æ–π –∂–µ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
- ‚ö° –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –≤–∞–∫–∞–Ω—Å–∏–π (–Ω–µ—Å–∫–æ–ª—å–∫–æ Skyvern –∑–∞–¥–∞—á –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ)
- üìä –î–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–∞–∂–¥–æ–π –≤–∞–∫–∞–Ω—Å–∏–∏
- üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –¥–ª—è failed jobs
- üìÖ Scheduled scans —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º–∏

## –í–æ–ø—Ä–æ—Å—ã?

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
```bash
tail -f worker/worker.log
```
