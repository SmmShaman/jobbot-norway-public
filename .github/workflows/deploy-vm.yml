name: üöÄ Auto-Deploy to VM

on:
  push:
    branches:
      - claude/continue-metadata-scheduler-011CUvwSPhPwyxdh3jTQYAYu
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Worker v2 to VM
    runs-on: self-hosted  # This will run on your VM's GitHub Actions Runner

    steps:
      - name: üìç Checkout latest code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üìä Show current status
        run: |
          echo "======================================================================"
          echo "üöÄ Auto-Deploy Started"
          echo "======================================================================"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Commit message: ${{ github.event.head_commit.message }}"
          echo "======================================================================"

      - name: üîÑ Pull latest changes
        run: |
          cd /home/stuard/jobbot-norway-public
          git fetch origin
          git pull origin ${{ github.ref_name }}
          echo "‚úÖ Code updated!"

      - name: üì¶ Install/Update Python dependencies
        run: |
          cd /home/stuard/jobbot-norway-public/worker

          # Check if venv exists
          if [ -d "venv" ]; then
            echo "üì¶ Using venv..."
            source venv/bin/activate
            pip install -r requirements.txt
          else
            echo "üì¶ Installing globally..."
            pip3 install -r requirements.txt
          fi

          echo "‚úÖ Dependencies updated!"

      - name: üîç Check Worker process
        run: |
          echo "üîç Checking if Worker is running..."

          WORKER_PID=$(pgrep -f "python3 worker_v2.py" || echo "")

          if [ -n "$WORKER_PID" ]; then
            echo "‚úÖ Worker is running (PID: $WORKER_PID)"
          else
            echo "‚ö†Ô∏è Worker is NOT running"
          fi

      - name: üîÑ Restart Worker
        run: |
          cd /home/stuard/jobbot-norway-public/worker

          echo "üõë Stopping old Worker..."
          pkill -f "python3 worker_v2.py" || echo "No running Worker found"

          sleep 2

          echo "üöÄ Starting new Worker..."

          if [ -d "venv" ]; then
            source venv/bin/activate
          fi

          nohup python3 worker_v2.py > worker.log 2>&1 &

          NEW_PID=$!
          echo "‚úÖ Worker started (PID: $NEW_PID)"

          sleep 3

          # Verify it's running
          if ps -p $NEW_PID > /dev/null; then
            echo "‚úÖ Worker is alive!"
            tail -20 worker.log
          else
            echo "‚ùå Worker failed to start!"
            tail -50 worker.log
            exit 1
          fi

      - name: ‚úÖ Deployment Summary
        run: |
          echo ""
          echo "======================================================================"
          echo "‚úÖ DEPLOYMENT COMPLETE!"
          echo "======================================================================"
          echo "üìä Worker Status:"
          ps aux | grep -i '[p]ython.*worker' || echo "‚ö†Ô∏è Worker not found"
          echo ""
          echo "üìÑ Last 10 log lines:"
          tail -10 /home/stuard/jobbot-norway-public/worker/worker.log
          echo "======================================================================"
