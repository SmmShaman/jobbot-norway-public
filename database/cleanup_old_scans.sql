-- ====================================================================
-- CLEANUP SCRIPT: –í–∏–¥–∞–ª–µ–Ω–Ω—è —Å—Ç–∞—Ä–∏—Ö —Å–∫–∞–Ω—É–≤–∞–Ω—å —Ç–∞ –¥–∂–æ–±—ñ–≤
-- ====================================================================
-- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —Ü–µ–π —Å–∫—Ä–∏–ø—Ç –≤ Supabase SQL Editor –¥–ª—è –æ—á–∏—â–µ–Ω–Ω—è –±–∞–∑–∏
-- URL: https://supabase.com/dashboard/project/ptrmidlhfdbybxmyovtm/sql/new
-- ====================================================================

-- ============================================================
-- –ü–û–ü–ï–†–ï–î–ñ–ï–ù–ù–Ø: –¶–µ –≤–∏–¥–∞–ª–∏—Ç—å –¥–∞–Ω—ñ! –°—Ç–≤–æ—Ä—ñ—Ç—å –±–µ–∫–∞–ø —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
-- ============================================================

-- 1Ô∏è‚É£ –ü–ï–†–ï–í–Ü–†–ö–ê: –ü–æ–¥–∏–≤–∏—Ç–∏—Å—å —Å–∫—ñ–ª—å–∫–∏ —î scan_tasks
SELECT
    status,
    COUNT(*) as count,
    MIN(created_at) as oldest,
    MAX(created_at) as newest
FROM scan_tasks
GROUP BY status
ORDER BY status;

-- 2Ô∏è‚É£ –ü–ï–†–ï–í–Ü–†–ö–ê: –ü–æ–¥–∏–≤–∏—Ç–∏—Å—å —Å–∫—ñ–ª—å–∫–∏ —î jobs
SELECT
    skyvern_status,
    COUNT(*) as count,
    MIN(created_at) as oldest,
    MAX(created_at) as newest
FROM jobs
GROUP BY skyvern_status
ORDER BY skyvern_status;

-- ============================================================
-- –í–ò–î–ê–õ–ï–ù–ù–Ø –î–ê–ù–ò–• (—Ä–æ–∑–∫–æ–º–µ–Ω—Ç—É–π—Ç–µ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –∫–æ–º–∞–Ω–¥–∏)
-- ============================================================

-- üóëÔ∏è –û–ø—Ü—ñ—è 1: –í–∏–¥–∞–ª–∏—Ç–∏ –í–°–Ü —Å—Ç–∞—Ä—ñ scan_tasks
-- DELETE FROM scan_tasks;

-- üóëÔ∏è –û–ø—Ü—ñ—è 2: –í–∏–¥–∞–ª–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ COMPLETED —Ç–∞ FAILED scan_tasks
-- DELETE FROM scan_tasks
-- WHERE status IN ('COMPLETED', 'FAILED');

-- üóëÔ∏è –û–ø—Ü—ñ—è 3: –í–∏–¥–∞–ª–∏—Ç–∏ scan_tasks —Å—Ç–∞—Ä—ñ—à—ñ –∑–∞ –ø–µ–≤–Ω—É –¥–∞—Ç—É
-- DELETE FROM scan_tasks
-- WHERE created_at < '2025-11-08'::timestamp;

-- üóëÔ∏è –û–ø—Ü—ñ—è 4: –í–∏–¥–∞–ª–∏—Ç–∏ –í–°–Ü jobs
-- DELETE FROM jobs;

-- üóëÔ∏è –û–ø—Ü—ñ—è 5: –í–∏–¥–∞–ª–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ FAILED jobs
-- DELETE FROM jobs
-- WHERE skyvern_status = 'FAILED';

-- üóëÔ∏è –û–ø—Ü—ñ—è 6: –í–∏–¥–∞–ª–∏—Ç–∏ jobs –±–µ–∑ –¥–µ—Ç–∞–ª–µ–π (—Ç—ñ–ª—å–∫–∏ PENDING)
-- DELETE FROM jobs
-- WHERE skyvern_status = 'PENDING' AND is_processed = false;

-- ============================================================
-- –†–ï–ö–û–ú–ï–ù–î–ê–¶–Ü–Ø: –í–∏–¥–∞–ª–∏—Ç–∏ –í–°–ï —ñ –ø–æ—á–∞—Ç–∏ –∑ —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞
-- ============================================================
-- –†–æ–∑–∫–æ–º–µ–Ω—Ç—É–π—Ç–µ –Ω–∞—Å—Ç—É–ø–Ω—ñ 2 —Ä—è–¥–∫–∏ –¥–ª—è –ø–æ–≤–Ω–æ–≥–æ –æ—á–∏—â–µ–Ω–Ω—è:

-- DELETE FROM jobs;
-- DELETE FROM scan_tasks;

-- ============================================================
-- –ü–ï–†–ï–í–Ü–†–ö–ê –ü–Ü–°–õ–Ø –í–ò–î–ê–õ–ï–ù–ù–Ø
-- ============================================================

-- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —â–æ –∑–∞–ª–∏—à–∏–ª–æ—Å—å:
SELECT 'scan_tasks' as table_name, COUNT(*) as remaining FROM scan_tasks
UNION ALL
SELECT 'jobs' as table_name, COUNT(*) as remaining FROM jobs;

-- ============================================================
-- RESET AUTO-INCREMENT (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
-- ============================================================
-- –Ø–∫—â–æ —Ö–æ—á–µ—Ç–µ —Å–∫–∏–Ω—É—Ç–∏ ID counter –¥–æ 1:

-- ALTER SEQUENCE scan_tasks_id_seq RESTART WITH 1;
-- ALTER SEQUENCE jobs_id_seq RESTART WITH 1;
